From cae23abd6a988b4f235604bc4832c00bf1ec3c7d Mon Sep 17 00:00:00 2001
From: dslarm <david+dslarm@lecomber.net>
Date: Tue, 16 Sep 2025 19:51:49 +0000
Subject: [PATCH 34/34] Fix incorrect target when cross-compiling in bazel
 config

---
 third_party/llvm/dirty.patch   | 11 +++++++++++
 third_party/llvm/workspace.bzl |  1 +
 2 files changed, 12 insertions(+)
 create mode 100644 third_party/llvm/dirty.patch

diff --git a/third_party/llvm/dirty.patch b/third_party/llvm/dirty.patch
new file mode 100644
index 00000000000..db99a4e597d
--- /dev/null
+++ b/third_party/llvm/dirty.patch
@@ -0,0 +1,11 @@
+--- a/utils/bazel/llvm-project-overlay/llvm/config.bzl	2025-04-17 16:11:50.417140143 +0000
++++ b/utils/bazel/llvm-project-overlay/llvm/config.bzl	2025-04-17 16:11:54.891132310 +0000
+@@ -103,7 +103,7 @@
+     "@bazel_tools//src/conditions:linux_aarch64": native_arch_defines("AArch64", "aarch64-unknown-linux-gnu"),
+     "@bazel_tools//src/conditions:linux_ppc64le": native_arch_defines("PowerPC", "powerpc64le-unknown-linux-gnu"),
+     "@bazel_tools//src/conditions:linux_s390x": native_arch_defines("SystemZ", "systemz-unknown-linux_gnu"),
+-    "//conditions:default": native_arch_defines("X86", "x86_64-unknown-linux-gnu"),
++    "//conditions:default": native_arch_defines("AArch64", "aarch64-unknown-linux-gnu"),
+ }) + [
+     "LLVM_VERSION_MAJOR={}".format(LLVM_VERSION_MAJOR),
+     "LLVM_VERSION_MINOR={}".format(LLVM_VERSION_MINOR),
diff --git a/third_party/llvm/workspace.bzl b/third_party/llvm/workspace.bzl
index dc3ceaddaea..924293650ca 100644
--- a/third_party/llvm/workspace.bzl
+++ b/third_party/llvm/workspace.bzl
@@ -22,6 +22,7 @@ def repo(name):
             "//third_party/llvm:mathextras.patch",
             "//third_party/llvm:toolchains.patch",
             "//third_party/llvm:zstd.patch",
+            "//third_party/llvm:dirty.patch",
         ],
         link_files = {"//third_party/llvm:run_lit.sh": "mlir/run_lit.sh"},
     )
-- 
2.47.1

