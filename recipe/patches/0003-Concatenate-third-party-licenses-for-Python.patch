From ef72719e49fafc6d66e5e90f2ba015cfcfdc4496 Mon Sep 17 00:00:00 2001
From: "Uwe L. Korn" <uwe.korn@quantco.com>
Date: Tue, 8 Mar 2022 20:59:29 +0100
Subject: [PATCH] Concatenate third-party licenses for Python

---
 tensorflow/tools/pip_package/BUILD            | 18 ++++++++++--
 tensorflow/tools/pip_package/MANIFEST.in      |  1 +
 .../tools/pip_package/concat_licenses.sh      | 28 +++++++++++++++++++
 4 files changed, 47 insertions(+), 2 deletions(-)
 create mode 100755 tensorflow/tools/pip_package/concat_licenses.sh

diff --git a/tensorflow/tools/pip_package/BUILD b/tensorflow/tools/pip_package/BUILD
index 1c0e65e8..422492a7 100644
--- a/tensorflow/tools/pip_package/BUILD
+++ b/tensorflow/tools/pip_package/BUILD
@@ -90,6 +90,7 @@ DYNAMIC_LOADED_KERNELS = [
 
 COMMON_PIP_DEPS = [
     ":licenses",
+    ":pylicenses_generate",
     "MANIFEST.in",
     "README",
     "setup.py",
@@ -176,8 +177,12 @@ py_binary(
 
 filegroup(
     name = "licenses",
-    data = [
-        "//:LICENSE",
+    data = ["//:LICENSE", ":license_files"],
+)
+
+filegroup(
+    name = "license_files",
+    srcs = [
         "//third_party/eigen3:LICENSE",
         "//third_party/fft2d:LICENSE",
         "//third_party/icu/data:LICENSE",
@@ -307,3 +312,12 @@ genrule(
     }),
     visibility = ["//visibility:public"],
 )
+
+genrule(
+    name = "pylicenses_generate",
+    srcs = [":license_files"],
+    outs = ["THIRD_PARTY_TF_PY_LICENSES"],
+    cmd = "$(location :concat_licenses.sh) $(SRCS) >$@",
+    tools = [":concat_licenses.sh"],
+    visibility = ["//visibility:public"],
+)
diff --git a/tensorflow/tools/pip_package/MANIFEST.in b/tensorflow/tools/pip_package/MANIFEST.in
index 51c1dc52..bde2ebd1 100644
--- a/tensorflow/tools/pip_package/MANIFEST.in
+++ b/tensorflow/tools/pip_package/MANIFEST.in
@@ -1,4 +1,5 @@
 include LICENSE
+include THIRD_PARTY_TF_PY_LICENSES
 include README
 recursive-include * *.py
 recursive-include * *.pyd
diff --git a/tensorflow/tools/pip_package/concat_licenses.sh b/tensorflow/tools/pip_package/concat_licenses.sh
new file mode 100755
index 00000000..2070f64e
--- /dev/null
+++ b/tensorflow/tools/pip_package/concat_licenses.sh
@@ -0,0 +1,28 @@
+#!/usr/bin/env bash
+# Copyright 2016 The TensorFlow Authors. All Rights Reserved.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+# ==============================================================================
+#
+# Script aimed to combining multiple license files into a single one.
+
+for f in $@
+do
+  echo "--------------------------------------------------------------------------------"
+  echo "BEGIN LICENSE FOR $f"
+  echo "--------------------------------------------------------------------------------"
+  cat $f
+  echo "--------------------------------------------------------------------------------"
+  echo "END LICENSE FOR $f"
+  echo "--------------------------------------------------------------------------------"
+done
-- 
2.32.0 (Apple Git-132)

