From bb3c4ea69738f3a614c6b1498a092f845af336f1 Mon Sep 17 00:00:00 2001
From: Mike Kruskal <mkruskal@google.com>
Date: Thu, 2 Mar 2023 09:30:34 -0800
Subject: [PATCH 1/2] Migrate syntax reflection to new feature-based system.

PiperOrigin-RevId: 513560350
---
 .../tools/proto_text/gen_proto_text_functions_lib.cc  | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/tensorflow/tools/proto_text/gen_proto_text_functions_lib.cc b/tensorflow/tools/proto_text/gen_proto_text_functions_lib.cc
index 4378e0b6..af89dc13 100644
--- a/tensorflow/tools/proto_text/gen_proto_text_functions_lib.cc
+++ b/tensorflow/tools/proto_text/gen_proto_text_functions_lib.cc
@@ -250,7 +250,14 @@ string GetHeaderGuard(const FileDescriptor& fd, bool impl) {
 void Generator::AppendFieldValueAppend(const FieldDescriptor& field,
                                        const bool omit_default,
                                        const string& field_expr) {
+  // This does not emit code with proper presence semantics (e.g. it doesn't
+  // check 'has' fields on non-messages).
+  CHECK(!field.has_presence() || field.containing_oneof() != nullptr ||
+        field.cpp_type() == FieldDescriptor::CPPTYPE_MESSAGE)
+      << field.file()->name();
+
   SetOutput(&cc_);
+
   switch (field.cpp_type()) {
     case FieldDescriptor::CPPTYPE_INT32:
     case FieldDescriptor::CPPTYPE_INT64:
@@ -761,10 +768,6 @@ void GetAllFileDescriptorsFromFile(const FileDescriptor* fd,
 }
 
 void Generator::Generate(const FileDescriptor& fd) {
-  // This does not emit code with proper proto2 semantics (e.g. it doesn't check
-  // 'has' fields on non-messages), so check that only proto3 is passed.
-  CHECK_EQ(fd.syntax(), FileDescriptor::SYNTAX_PROTO3) << fd.name();
-
   const string package = fd.package();
   std::set<const FileDescriptor*> all_fd;
   std::set<const Descriptor*> all_d;
-- 
2.30.2

